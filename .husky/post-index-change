#!/bin/sh

# SPDX-License-Identifier: MIT

. "$(dirname "$0")/_/husky.sh"

if [ $2 -eq 1 ]; then
  exit 0
fi

PACKAGE_FILE_REGEX="^(package\.json|pnpm-lock\.yaml)"
PACKAGES="$(git diff --cached --name-only | grep -E "$PACKAGE_FILE_REGEX" || :)"
if [[ ${PACKAGES[@]} ]]; then
  echo "ğŸ“¦ $(echo $PACKAGES | tr '\n' ' ')ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚pnpm install ã‚’å®Ÿè¡Œã—ã¾ã™..."
  pnpm install --frozen-lockfile && :
  if [ $? -ne 0 ]; then
    echo "ğŸš¨ pnpm install ã«å¤±æ•—ã—ã¾ã—ãŸã€‚restore ã‚’å®Ÿè¡Œã—ã¾ã™..."
    git restore --staged .
    exit 1
  fi
else
  echo "ğŸ§Š ä¾å­˜é–¢ä¿‚ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
fi
